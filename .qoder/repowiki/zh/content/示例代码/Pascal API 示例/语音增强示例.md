# 语音增强示例

<cite>
**本文档引用的文件**   
- [gtcrn.pas](file://pascal-api-examples/speech-enhancement-gtcrn/gtcrn.pas)
- [run-gtcrn.sh](file://pascal-api-examples/speech-enhancement-gtcrn/run-gtcrn.sh)
- [sherpa_onnx.pas](file://sherpa-onnx/pascal-api/sherpa_onnx.pas)
- [offline-speech-denoiser-gtcrn-impl.h](file://sherpa-onnx/csrc/offline-speech-denoiser-gtcrn-impl.h)
- [offline-speech-denoiser.h](file://sherpa-onnx/csrc/offline-speech-denoiser.h)
- [offline-speech-denoiser-gtcrn-model.h](file://sherpa-onnx/csrc/offline-speech-denoiser-gtcrn-model.h)
- [offline-speech-denoiser-gtcrn-model-meta-data.h](file://sherpa-onnx/csrc/offline-speech-denoiser-gtcrn-model-meta-data.h)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [语音增强实现机制](#语音增强实现机制)
5. [GTCRN模型处理流程](#gtcrn模型处理流程)
6. [输入输出音频对比分析](#输入输出音频对比分析)
7. [实际应用价值](#实际应用价值)

## 简介
本示例展示了如何使用sherpa-onnx的Pascal API实现语音增强功能，特别是利用GTCRN（Gated Temporal Convolutional Recurrent Network）模型对带噪声的语音信号进行降噪处理。该示例通过加载预训练的GTCRN模型，对输入的噪声语音进行处理，生成清晰的输出语音，从而提升语音质量。

## 项目结构
语音增强示例位于`pascal-api-examples/speech-enhancement-gtcrn/`目录下，包含Pascal源代码文件和运行脚本。该示例展示了如何使用离线语音去噪器对音频文件进行处理。

```mermaid
graph TD
A[语音增强示例] --> B[gtcrn.pas]
A --> C[run-gtcrn.sh]
A --> D[inp_16k.wav]
A --> E[gtcrn_simple.onnx]
B --> F[调用sherpa_onnx API]
C --> G[构建和运行脚本]
D --> H[输入噪声音频]
E --> I[GTCRN模型文件]
```

**图示来源**
- [gtcrn.pas](file://pascal-api-examples/speech-enhancement-gtcrn/gtcrn.pas)
- [run-gtcrn.sh](file://pascal-api-examples/speech-enhancement-gtcrn/run-gtcrn.sh)

**本节来源**
- [gtcrn.pas](file://pascal-api-examples/speech-enhancement-gtcrn/gtcrn.pas)
- [run-gtcrn.sh](file://pascal-api-examples/speech-enhancement-gtcrn/run-gtcrn.sh)

## 核心组件
本示例的核心组件包括语音增强配置、离线语音去噪器和去噪后的音频数据结构。通过Pascal API提供的接口，实现了从噪声语音到清晰语音的转换过程。

**本节来源**
- [sherpa_onnx.pas](file://sherpa-onnx/pascal-api/sherpa_onnx.pas)
- [gtcrn.pas](file://pascal-api-examples/speech-enhancement-gtcrn/gtcrn.pas)

## 语音增强实现机制
GTCRN语音增强示例通过一系列步骤实现噪声语音的增强和降噪。首先，程序读取输入的噪声音频文件，然后加载GTCRN模型配置，创建离线语音去噪器实例，最后对音频进行处理并保存增强后的结果。

```mermaid
sequenceDiagram
participant 主程序
participant 语音读取
participant 去噪器配置
participant GTCRN模型
participant 音频写入
主程序->>语音读取 : 调用SherpaOnnxReadWave读取inp_16k.wav
语音读取-->>主程序 : 返回TSherpaOnnxWave对象
主程序->>去噪器配置 : 初始化TSherpaOnnxOfflineSpeechDenoiserConfig
去噪器配置->>GTCRN模型 : 设置模型路径为gtcrn_simple.onnx
GTCRN模型-->>主程序 : 返回配置完成的去噪器
主程序->>GTCRN模型 : 创建TSherpaOnnxOfflineSpeechDenoiser实例
主程序->>GTCRN模型 : 调用Run方法处理音频样本
GTCRN模型-->>主程序 : 返回TSherpaOnnxDenoisedAudio对象
主程序->>音频写入 : 调用SherpaOnnxWriteWave保存enhanced-16k.wav
音频写入-->>主程序 : 写入完成，输出保存信息
```

**图示来源**
- [gtcrn.pas](file://pascal-api-examples/speech-enhancement-gtcrn/gtcrn.pas)
- [offline-speech-denoiser.h](file://sherpa-onnx/csrc/offline-speech-denoiser.h)

**本节来源**
- [gtcrn.pas](file://pascal-api-examples/speech-enhancement-gtcrn/gtcrn.pas)
- [sherpa_onnx.pas](file://sherpa-onnx/pascal-api/sherpa_onnx.pas)

## GTCRN模型处理流程
GTCRN模型的处理流程基于短时傅里叶变换（STFT）和逆短时傅里叶变换（ISTFT）技术。模型首先将输入的时域音频信号转换为频域表示，然后通过GTCRN网络进行噪声抑制，最后将处理后的频域信号转换回时域，生成清晰的语音输出。

```mermaid
flowchart TD
A[输入音频] --> B[短时傅里叶变换STFT]
B --> C[频域表示]
C --> D[GTCRN模型处理]
D --> E[噪声抑制]
E --> F[增强的频域信号]
F --> G[逆短时傅里叶变换ISTFT]
G --> H[输出清晰音频]
style A fill:#f9f,stroke:#333
style H fill:#bbf,stroke:#333
```

**图示来源**
- [offline-speech-denoiser-gtcrn-impl.h](file://sherpa-onnx/csrc/offline-speech-denoiser-gtcrn-impl.h)
- [offline-speech-denoiser-gtcrn-model-meta-data.h](file://sherpa-onnx/csrc/offline-speech-denoiser-gtcrn-model-meta-data.h)

**本节来源**
- [offline-speech-denoiser-gtcrn-impl.h](file://sherpa-onnx/csrc/offline-speech-denoiser-gtcrn-impl.h)
- [offline-speech-denoiser-gtcrn-model.h](file://sherpa-onnx/csrc/offline-speech-denoiser-gtcrn-model.h)

## 输入输出音频对比分析
为了评估语音增强效果，可以通过对比输入噪声音频和输出增强音频的频谱特征来进行分析。通常，增强后的音频在频谱上会显示出更清晰的语音特征，噪声成分被有效抑制，语音的可懂度和质量得到显著提升。

```mermaid
graph LR
subgraph 输入音频
A[噪声语音频谱]
B[背景噪声明显]
C[语音特征模糊]
end
subgraph 输出音频
D[增强语音频谱]
E[背景噪声抑制]
F[语音特征清晰]
end
A --> |GTCRN处理| D
B --> |降噪| E
C --> |增强| F
```

**图示来源**
- [offline-speech-denoiser-gtcrn-impl.h](file://sherpa-onnx/csrc/offline-speech-denoiser-gtcrn-impl.h)
- [offline-speech-denoiser.h](file://sherpa-onnx/csrc/offline-speech-denoiser.h)

**本节来源**
- [gtcrn.pas](file://pascal-api-examples/speech-enhancement-gtcrn/gtcrn.pas)
- [offline-speech-denoiser-gtcrn-impl.h](file://sherpa-onnx/csrc/offline-speech-denoiser-gtcrn-impl.h)

## 实际应用价值
语音增强技术在实际应用中具有重要价值，特别是在提升自动语音识别（ASR）系统的前端处理质量方面。通过使用GTCRN等先进模型对输入语音进行预处理，可以显著提高ASR系统在噪声环境下的识别准确率，从而改善用户体验。

**本节来源**
- [gtcrn.pas](file://pascal-api-examples/speech-enhancement-gtcrn/gtcrn.pas)
- [offline-speech-denoiser-gtcrn-impl.h](file://sherpa-onnx/csrc/offline-speech-denoiser-gtcrn-impl.h)