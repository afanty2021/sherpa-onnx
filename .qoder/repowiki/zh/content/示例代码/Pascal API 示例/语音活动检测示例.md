# 语音活动检测示例

<cite>
**本文档引用的文件**
- [circular_buffer.pas](file://pascal-api-examples/vad/circular_buffer.pas)
- [remove_silence.pas](file://pascal-api-examples/vad/remove_silence.pas)
- [remove_silence_ten_vad.pas](file://pascal-api-examples/vad/remove_silence_ten_vad.pas)
- [sherpa_onnx.pas](file://sherpa-onnx/pascal-api/sherpa_onnx.pas)
- [run-circular-buffer.sh](file://pascal-api-examples/vad/run-circular-buffer.sh)
- [run-remove-silence.sh](file://pascal-api-examples/vad/run-remove-silence.sh)
- [run-remove-silence-ten-vad.sh](file://pascal-api-examples/vad/run-remove-silence-ten-vad.sh)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [环形缓冲区实现原理](#环形缓冲区实现原理)
3. [语音活动检测核心功能](#语音活动检测核心功能)
4. [Silero-VAD与Ten-VAD对比分析](#silero-vad与ten-vad对比分析)
5. [VAD与ASR集成应用](#vad与asr集成应用)
6. [性能优化与参数调优](#性能优化与参数调优)

## 项目结构

```mermaid
graph TD
A[VAD示例目录] --> B[circular_buffer.pas]
A --> C[remove_silence.pas]
A --> D[remove_silence_ten_vad.pas]
A --> E[run-circular-buffer.sh]
A --> F[run-remove-silence.sh]
A --> G[run-remove-silence-ten-vad.sh]
A --> H[README.md]
B --> I[环形缓冲区操作]
C --> J[Silero-VAD静音移除]
D --> K[Ten-VAD静音移除]
E --> L[编译运行环形缓冲区]
F --> M[编译运行Silero-VAD]
G --> N[编译运行Ten-VAD]
```

**图示来源**
- [circular_buffer.pas](file://pascal-api-examples/vad/circular_buffer.pas)
- [remove_silence.pas](file://pascal-api-examples/vad/remove_silence.pas)
- [remove_silence_ten_vad.pas](file://pascal-api-examples/vad/remove_silence_ten_vad.pas)
- [run-circular-buffer.sh](file://pascal-api-examples/vad/run-circular-buffer.sh)
- [run-remove-silence.sh](file://pascal-api-examples/vad/run-remove-silence.sh)
- [run-remove-silence-ten-vad.sh](file://pascal-api-examples/vad/run-remove-silence-ten-vad.sh)

**本节来源**
- [README.md](file://pascal-api-examples/vad/README.md)

## 环形缓冲区实现原理

`circular_buffer.pas`示例展示了Sherpa-ONNX中环形缓冲区的使用方法。该数据结构在实时音频处理中至关重要，能够高效管理音频数据流。

环形缓冲区的核心特性包括：
- **自动扩容**：初始容量为5，当数据量超过容量时会自动调整大小
- **头部指针**：`Head`属性指向缓冲区起始位置，即使超过容量也不会重置
- **高效操作**：`Push`、`Pop`和`Get`操作的时间复杂度均为O(1)

在实时音频处理场景中，环形缓冲区的优势体现在：
1. **内存效率**：避免频繁的内存分配和释放
2. **低延迟**：支持连续的数据流处理
3. **线程安全**：适合多线程环境下的音频数据交换

```mermaid
flowchart TD
Start([缓冲区创建]) --> Push["Push([0,10,20])"]
Push --> CheckSize["Size=3, Head=0"]
CheckSize --> PushMore["Push([30,40,50,60])"]
PushMore --> Resize["自动扩容"]
Resize --> Pop["Pop(4)"]
Pop --> CheckHead["Size=3, Head=4"]
CheckHead --> Reset["Reset()"]
Reset --> End([缓冲区重置])
```

**图示来源**
- [circular_buffer.pas](file://pascal-api-examples/vad/circular_buffer.pas)

**本节来源**
- [circular_buffer.pas](file://pascal-api-examples/vad/circular_buffer.pas)

## 语音活动检测核心功能

`remove_silence.pas`和`remove_silence_ten_vad.pas`示例展示了如何使用VAD（语音活动检测）功能从音频文件中移除静音部分。

### VAD工作流程

```mermaid
sequenceDiagram
participant Audio as 音频文件
participant VAD as 语音活动检测器
participant Output as 输出文件
Audio->>VAD : 读取音频数据
loop 分块处理
VAD->>VAD : AcceptWaveform(窗口数据)
VAD->>VAD : 检测语音活动
alt 检测到语音段
VAD->>VAD : 生成SpeechSegment
VAD->>Output : 存储语音段
end
end
VAD->>VAD : Flush剩余数据
VAD->>Output : 合并所有语音段
Output->>Output : 保存无静音音频
```

**图示来源**
- [remove_silence.pas](file://pascal-api-examples/vad/remove_silence.pas)
- [remove_silence_ten_vad.pas](file://pascal-api-examples/vad/remove_silence_ten_vad.pas)

### 核心组件分析

**TSherpaOnnxVoiceActivityDetector类**提供以下关键方法：
- `AcceptWaveform`：接受音频波形数据进行处理
- `IsEmpty`：检查是否有待处理的语音段
- `Front`：获取最前面的语音段
- `Pop`：移除已处理的语音段
- `Flush`：强制处理剩余数据

**TSherpaOnnxSpeechSegment结构体**包含：
- `Start`：语音段起始位置（采样点）
- `Samples`：语音段音频数据

**本节来源**
- [remove_silence.pas](file://pascal-api-examples/vad/remove_silence.pas)
- [remove_silence_ten_vad.pas](file://pascal-api-examples/vad/remove_silence_ten_vad.pas)
- [sherpa_onnx.pas](file://sherpa-onnx/pascal-api/sherpa_onnx.pas)

## Silero-VAD与Ten-VAD对比分析

两种VAD模型在配置参数上存在显著差异：

| 参数 | Silero-VAD | Ten-VAD |
|------|----------|--------|
| **模型文件** | silero_vad.onnx | ten-vad.onnx |
| **窗口大小** | 512 | 256 |
| **阈值** | 0.5 | 0.25 |
| **最小语音时长** | 0.25秒 | 0.25秒 |
| **最小静音时长** | 0.5秒 | 0.5秒 |

```mermaid
graph LR
A[VAD模型选择] --> B[Silero-VAD]
A --> C[Ten-VAD]
B --> D[窗口大小: 512]
B --> E[阈值: 0.5]
B --> F[灵敏度: 中等]
C --> G[窗口大小: 256]
C --> H[阈值: 0.25]
C --> I[灵敏度: 高]
D --> J[处理延迟: 较高]
E --> K[误检率: 较低]
G --> L[处理延迟: 较低]
H --> M[误检率: 较高]
```

**图示来源**
- [remove_silence.pas](file://pascal-api-examples/vad/remove_silence.pas)
- [remove_silence_ten_vad.pas](file://pascal-api-examples/vad/remove_silence_ten_vad.pas)

**本节来源**
- [remove_silence.pas](file://pascal-api-examples/vad/remove_silence.pas)
- [remove_silence_ten_vad.pas](file://pascal-api-examples/vad/remove_silence_ten_vad.pas)

## VAD与ASR集成应用

语音活动检测可以与自动语音识别（ASR）系统结合使用，提高整体处理效率：

```mermaid
flowchart TD
A[原始音频] --> B{VAD检测}
B --> |语音段| C[ASR识别]
B --> |静音段| D[跳过处理]
C --> E[文本输出]
D --> F[减少计算量]
G[系统优势] --> H[降低CPU使用率]
G --> I[减少内存占用]
G --> J[提高识别速度]
```

**图示来源**
- [remove_silence.pas](file://pascal-api-examples/vad/remove_silence.pas)

**本节来源**
- [remove_silence.pas](file://pascal-api-examples/vad/remove_silence.pas)

## 性能优化与参数调优

### 关键参数调整

**阈值设置**：
- 高阈值（>0.7）：减少误检，但可能漏检弱语音
- 低阈值（<0.3）：提高灵敏度，但增加误检风险

**窗口大小选择**：
- 大窗口（512+）：处理延迟高，但稳定性好
- 小窗口（256）：响应速度快，适合实时应用

### 运行脚本分析

```mermaid
flowchart LR
A[运行脚本] --> B{检查依赖}
B --> |缺少| C[构建库文件]
B --> |完整| D[编译Pascal代码]
C --> D
D --> E{检查模型文件}
E --> |缺少| F[下载模型]
E --> |存在| G[执行程序]
F --> G
G --> H[输出结果]
```

**图示来源**
- [run-remove-silence.sh](file://pascal-api-examples/vad/run-remove-silence.sh)
- [run-remove-silence-ten-vad.sh](file://pascal-api-examples/vad/run-remove-silence-ten-vad.sh)

**本节来源**
- [run-circular-buffer.sh](file://pascal-api-examples/vad/run-circular-buffer.sh)
- [run-remove-silence.sh](file://pascal-api-examples/vad/run-remove-silence.sh)
- [run-remove-silence-ten-vad.sh](file://pascal-api-examples/vad/run-remove-silence-ten-vad.sh)