# 关键词检测示例

<cite>
**本文档中引用的文件**  
- [kws-c-api.c](file://c-api-examples/kws-c-api.c)
- [keywords-spotter-buffered-tokens-keywords-c-api.c](file://c-api-examples/keywords-spotter-buffered-tokens-keywords-c-api.c)
- [c-api.h](file://sherpa-onnx/c-api/c-api.h)
- [keyword-spotter.h](file://sherpa-onnx/csrc/keyword-spotter.h)
- [keyword-spotter.cc](file://sherpa-onnx/csrc/keyword-spotter.cc)
</cite>

## 目录
1. [简介](#简介)
2. [关键词检测功能与应用场景](#关键词检测功能与应用场景)
3. [kws-c-api.c示例代码解析](#kws-c-api.c示例代码解析)
4. [buffered-tokens实现机制](#buffered-tokens实现机制)
5. [性能调优建议](#性能调优建议)
6. [结论](#结论)

## 简介

sherpa-onnx是一个用于语音处理的开源工具包，提供了关键词检测（KWS）的C API接口。本示例文档详细介绍了如何使用C API实现关键词检测功能，包括配置关键词列表、设置检测灵敏度阈值、处理音频流并实时返回关键词触发事件。文档还深入解析了buffered-tokens的实现机制及其对检测精度的影响，并提供了性能调优建议。

**Section sources**
- [kws-c-api.c](file://c-api-examples/kws-c-api.c#L1-L153)

## 关键词检测功能与应用场景

关键词检测（Keyword Spotting, KWS）是一种语音识别技术，用于在连续的语音流中检测预定义的关键词或短语。该技术广泛应用于唤醒词识别（如"Hey Siri"、"OK Google"）、语音命令控制、智能家居设备、车载语音系统等场景。KWS系统能够在低功耗设备上实时运行，通过监听环境中的语音输入，当检测到特定关键词时触发相应的操作。

在sherpa-onnx中，关键词检测基于深度学习模型实现，支持多种模型架构，如Zipformer、Transducer等。系统能够处理16kHz采样的单声道音频数据，并通过声学模型和语言模型的结合，实现高精度的关键词识别。KWS功能特别适用于需要低延迟和高准确率的实时语音交互场景。

**Section sources**
- [kws-c-api.c](file://c-api-examples/kws-c-api.c#L5-L153)

## kws-c-api.c示例代码解析

`kws-c-api.c`示例代码展示了如何使用sherpa-onnx的C API进行关键词检测。代码首先配置关键词检测器的参数，包括模型路径、关键词文件、检测阈值等。然后创建关键词检测器实例，并通过音频流处理接口接收实时音频数据。

关键配置参数包括：
- `model_config.transducer.encoder`：编码器模型路径
- `model_config.transducer.decoder`：解码器模型路径
- `model_config.transducer.joiner`：连接器模型路径
- `model_config.tokens`：词汇表文件路径
- `keywords_file`：关键词列表文件路径
- `keywords_threshold`：关键词检测阈值
- `keywords_score`：关键词得分增益

代码通过`SherpaOnnxCreateKeywordSpotter`函数创建关键词检测器，然后使用`SherpaOnnxCreateKeywordStream`创建音频流处理实例。音频数据通过`SherpaOnnxOnlineStreamAcceptWaveform`函数输入，系统会实时检测关键词。当检测到关键词时，通过`SherpaOnnxGetKeywordResult`获取检测结果，并使用`SherpaOnnxResetKeywordStream`重置检测状态。

**Section sources**
- [kws-c-api.c](file://c-api-examples/kws-c-api.c#L23-L153)

## buffered-tokens实现机制

buffered-tokens机制允许将词汇表和关键词数据直接加载到内存缓冲区中，而不是从外部文件读取。这种实现方式提高了数据访问效率，减少了文件I/O操作，特别适用于嵌入式系统或对启动时间有严格要求的应用场景。

在`keywords-spotter-buffered-tokens-keywords-c-api.c`示例中，通过`ReadFile`函数将`tokens.txt`和`test_keywords.txt`文件内容读取到内存缓冲区中。然后在配置结构体中使用`tokens_buf`和`keywords_buf`字段指向这些缓冲区，并通过`tokens_buf_size`和`keywords_buf_size`指定缓冲区大小。

这种机制的优势包括：
1. 减少文件系统依赖，提高系统可靠性
2. 提升数据加载速度，缩短初始化时间
3. 支持动态更新关键词列表
4. 便于在资源受限的设备上部署

buffered-tokens机制对检测精度的影响主要体现在数据一致性和完整性上。由于数据直接在内存中处理，避免了文件读取过程中的潜在错误，确保了词汇表和关键词数据的准确加载，从而提高了检测的稳定性和准确性。

**Section sources**
- [keywords-spotter-buffered-tokens-keywords-c-api.c](file://c-api-examples/keywords-spotter-buffered-tokens-keywords-c-api.c#L24-L197)
- [c-api.h](file://sherpa-onnx/c-api/c-api.h#L126-L130)

## 性能调优建议

为了优化关键词检测的性能，建议从以下几个方面进行调优：

### 模型选择
选择适合应用场景的模型架构。对于资源受限的设备，推荐使用轻量级模型如Zipformer-Mobile；对于高精度要求的场景，可选择更复杂的模型。模型的大小和计算复杂度直接影响检测速度和资源消耗。

### 关键词长度
合理设置关键词长度。过短的关键词容易产生误触发，过长的关键词则可能增加检测延迟。建议关键词长度在2-4个音节之间，既能保证识别准确性，又能维持较低的误报率。

### 音频采样率
确保音频采样率与模型训练时的采样率一致（通常为16kHz）。如果输入音频采样率不同，系统会进行重采样，这会增加计算开销。建议在前端处理中统一音频采样率，避免实时重采样带来的性能损耗。

### 检测阈值调优
根据应用场景调整`keywords_threshold`参数。较高的阈值（如0.3-0.5）可降低误报率但可能漏检；较低的阈值（如0.1-0.2）提高灵敏度但增加误报风险。建议通过实际测试找到最佳平衡点。

### 多线程优化
利用`SherpaOnnxDecodeMultipleKeywordStreams`函数实现多流并行处理，充分利用多核CPU的计算能力，提高系统吞吐量。

**Section sources**
- [kws-c-api.c](file://c-api-examples/kws-c-api.c#L47-L50)
- [keyword-spotter.h](file://sherpa-onnx/csrc/keyword-spotter.h#L53-L71)

## 结论

sherpa-onnx的关键词检测C API提供了一套完整且高效的解决方案，适用于各种语音交互场景。通过合理配置模型参数、优化关键词列表和音频处理流程，可以实现高精度、低延迟的关键词检测。buffered-tokens机制进一步提升了系统的部署灵活性和运行效率。开发者可以根据具体应用场景，结合性能调优建议，构建稳定可靠的语音唤醒和命令识别系统。