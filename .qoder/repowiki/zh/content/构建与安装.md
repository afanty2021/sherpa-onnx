# 构建与安装

<cite>
**本文档中引用的文件**   
- [CMakeLists.txt](file://CMakeLists.txt)
- [setup.py](file://setup.py)
- [pom.xml](file://pom.xml)
- [sherpa-onnx/CMakeLists.txt](file://sherpa-onnx/CMakeLists.txt)
- [cmake/cmake_extension.py](file://cmake/cmake_extension.py)
- [toolchains/aarch64-linux-gnu.toolchain.cmake](file://toolchains/aarch64-linux-gnu.toolchain.cmake)
- [toolchains/arm-linux-gnueabihf.toolchain.cmake](file://toolchains/arm-linux-gnueabihf.toolchain.cmake)
- [toolchains/riscv64-linux-gnu.toolchain.cmake](file://toolchains/riscv64-linux-gnu.toolchain.cmake)
- [toolchains/riscv64-linux-gnu-spacemit.toolchain.cmake](file://toolchains/riscv64-linux-gnu-spacemit.toolchain.cmake)
- [release.sh](file://release.sh)
</cite>

## 目录
1. [简介](#简介)
2. [使用CMake进行编译](#使用cmake进行编译)
3. [Python包安装](#python包安装)
4. [Java项目集成](#java项目集成)
5. [不同操作系统的构建指南](#不同操作系统的构建指南)
6. [不同平台的构建指南](#不同平台的构建指南)
7. [硬件架构交叉编译](#硬件架构交叉编译)
8. [常见构建错误排查](#常见构建错误排查)

## 简介

sherpa-onnx是一个支持多种语音处理功能的开源项目，包括语音识别、语音合成、说话人分离、说话人识别等。该项目支持在多种操作系统和平台上构建和安装，包括Linux、Windows、macOS、Android、iOS、HarmonyOS和WebAssembly。本指南将详细介绍如何使用CMake进行编译，通过setup.py安装Python包，通过pom.xml集成Java项目，以及针对不同硬件架构的交叉编译指南。

**Section sources**
- [README.md](file://README.md#L1-L590)

## 使用CMake进行编译

### 依赖项安装

在使用CMake编译sherpa-onnx之前，需要安装必要的依赖项。这些依赖项包括CMake、编译器（如GCC或Clang）、Python开发包、以及特定于操作系统的开发工具。

### 配置选项

sherpa-onnx的CMake配置提供了多个选项来定制构建过程。主要的配置选项包括：

- `SHERPA_ONNX_ENABLE_PYTHON`: 是否构建Python绑定
- `SHERPA_ONNX_ENABLE_TESTS`: 是否构建测试
- `SHERPA_ONNX_ENABLE_CHECK`: 是否启用断言检查
- `BUILD_SHARED_LIBS`: 是否构建共享库
- `SHERPA_ONNX_ENABLE_PORTAUDIO`: 是否启用PortAudio支持
- `SHERPA_ONNX_ENABLE_JNI`: 是否构建JNI接口
- `SHERPA_ONNX_ENABLE_C_API`: 是否构建C API
- `SHERPA_ONNX_ENABLE_WEBSOCKET`: 是否构建WebSocket服务器/客户端
- `SHERPA_ONNX_ENABLE_GPU`: 是否启用ONNX Runtime GPU支持
- `SHERPA_ONNX_ENABLE_DIRECTML`: 是否启用ONNX Runtime DirectML支持

### 编译命令

使用CMake编译sherpa-onnx的基本步骤如下：

1. 创建构建目录并进入该目录
2. 运行CMake配置命令
3. 执行编译

```bash
mkdir build
cd build
cmake -DCMAKE_BUILD_TYPE=Release -DSHERPA_ONNX_ENABLE_PYTHON=ON ..
make -j$(nproc)
```

**Section sources**
- [CMakeLists.txt](file://CMakeLists.txt#L1-L580)

## Python包安装

### 使用setup.py安装

sherpa-onnx提供了setup.py脚本，用于安装Python包。安装步骤如下：

1. 确保已安装Python和pip
2. 运行setup.py脚本

```bash
python3 setup.py install
```

### 配置选项

setup.py脚本支持通过环境变量来配置构建选项。主要的环境变量包括：

- `SHERPA_ONNX_CMAKE_ARGS`: 传递给CMake的额外参数
- `SHERPA_ONNX_MAKE_ARGS`: 传递给make的额外参数
- `SHERPA_ONNX_ENABLE_ALSA`: 是否启用ALSA支持

**Section sources**
- [setup.py](file://setup.py#L1-L124)
- [cmake/cmake_extension.py](file://cmake/cmake_extension.py#L1-L297)

## Java项目集成

### 使用pom.xml集成

sherpa-onnx提供了pom.xml文件，用于在Java项目中集成。集成步骤如下：

1. 在项目的pom.xml文件中添加sherpa-onnx的依赖
2. 配置构建插件

```xml
<dependency>
    <groupId>com.k2fsa.sherpa.onnx</groupId>
    <artifactId>sherpa-onnx-android</artifactId>
    <version>1.12.19</version>
    <type>pom</type>
</dependency>
```

### 配置选项

pom.xml文件中的配置选项包括：

- `groupId`: 组ID
- `artifactId`: 构件ID
- `version`: 版本号
- `url`: 项目URL
- `packaging`: 打包类型

**Section sources**
- [pom.xml](file://pom.xml#L1-L20)

## 不同操作系统的构建指南

### Linux

在Linux上构建sherpa-onnx需要安装必要的开发工具和库。对于基于Debian的系统，可以使用以下命令安装依赖项：

```bash
sudo apt-get install build-essential cmake python3-dev
```

### Windows

在Windows上构建sherpa-onnx需要安装Visual Studio或MinGW。建议使用Visual Studio，因为它提供了完整的开发环境。

### macOS

在macOS上构建sherpa-onnx需要安装Xcode命令行工具。可以使用以下命令安装：

```bash
xcode-select --install
```

**Section sources**
- [README.md](file://README.md#L1-L590)

## 不同平台的构建指南

### Android

在Android上构建sherpa-onnx需要使用Android NDK。构建脚本`release.sh`提供了构建Android库的完整流程。

### iOS

在iOS上构建sherpa-onnx需要使用Xcode和iOS SDK。构建脚本`build-ios.sh`提供了构建iOS库的完整流程。

### HarmonyOS

在HarmonyOS上构建sherpa-onnx需要使用HarmonyOS SDK。构建脚本`release.sh`提供了构建HarmonyOS库的完整流程。

### WebAssembly

在WebAssembly上构建sherpa-onnx需要使用Emscripten。构建脚本`wasm/CMakeLists.txt`提供了构建WebAssembly库的完整流程。

**Section sources**
- [release.sh](file://release.sh#L1-L46)
- [README.md](file://README.md#L1-L590)

## 硬件架构交叉编译

### ARM架构

对于ARM架构的交叉编译，sherpa-onnx提供了相应的工具链文件。例如，`aarch64-linux-gnu.toolchain.cmake`用于64位ARM架构，`arm-linux-gnueabihf.toolchain.cmake`用于32位ARM架构。

### RISC-V架构

对于RISC-V架构的交叉编译，sherpa-onnx提供了`riscv64-linux-gnu.toolchain.cmake`和`riscv64-linux-gnu-spacemit.toolchain.cmake`两个工具链文件。

### 交叉编译命令

使用工具链文件进行交叉编译的命令如下：

```bash
cmake -DCMAKE_TOOLCHAIN_FILE=toolchains/aarch64-linux-gnu.toolchain.cmake ..
make -j$(nproc)
```

**Section sources**
- [toolchains/aarch64-linux-gnu.toolchain.cmake](file://toolchains/aarch64-linux-gnu.toolchain.cmake#L1-L19)
- [toolchains/arm-linux-gnueabihf.toolchain.cmake](file://toolchains/arm-linux-gnueabihf.toolchain.cmake#L1-L18)
- [toolchains/riscv64-linux-gnu.toolchain.cmake](file://toolchains/riscv64-linux-gnu.toolchain.cmake#L1-L18)
- [toolchains/riscv64-linux-gnu-spacemit.toolchain.cmake](file://toolchains/riscv64-linux-gnu-spacemit.toolchain.cmake#L1-L31)

## 常见构建错误排查

### 依赖项缺失

如果构建过程中出现依赖项缺失的错误，需要检查并安装相应的开发包。例如，在Linux上可能需要安装`libasound2-dev`包。

### 编译器版本不兼容

如果使用较旧的编译器版本，可能会出现编译错误。建议使用较新版本的GCC或Clang。

### 内存不足

在资源受限的设备上构建sherpa-onnx可能会遇到内存不足的问题。可以尝试减少并行编译的线程数，或增加交换空间。

### 平台特定问题

不同平台可能会有特定的构建问题。例如，在Windows上可能需要配置Visual Studio的环境变量，在macOS上可能需要处理代码签名问题。

**Section sources**
- [CMakeLists.txt](file://CMakeLists.txt#L1-L580)
- [README.md](file://README.md#L1-L590)